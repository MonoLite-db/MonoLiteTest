#!/bin/bash
# Created by Yanjunhui
# MonoLite ä¸‰è¯­è¨€ä¸€è‡´æ€§æµ‹è¯• - å¯è§†åŒ–æ¼”ç¤º

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# æ‰“å°å¸¦æ¡†çš„æ ‡é¢˜
print_header() {
    local text="$1"
    local len=${#text}
    local border=$(printf 'â•%.0s' $(seq 1 $((len + 4))))
    echo ""
    echo -e "${CYAN}â•”${border}â•—${NC}"
    echo -e "${CYAN}â•‘  ${WHITE}${text}${CYAN}  â•‘${NC}"
    echo -e "${CYAN}â•š${border}â•${NC}"
    echo ""
}

# æ‰“å°æ­¥éª¤
print_step() {
    local step="$1"
    local desc="$2"
    echo -e "${YELLOW}â–¶ Step ${step}:${NC} ${WHITE}${desc}${NC}"
}

# æ‰“å°å­æ­¥éª¤
print_substep() {
    local desc="$1"
    echo -e "  ${BLUE}â†’${NC} ${desc}"
}

# æ‰“å°æˆåŠŸ
print_success() {
    local msg="$1"
    echo -e "  ${GREEN}âœ“${NC} ${msg}"
}

# æ‰“å°å¤±è´¥
print_fail() {
    local msg="$1"
    echo -e "  ${RED}âœ—${NC} ${msg}"
}

# æ‰“å°æµç¨‹å›¾
print_flow_diagram() {
    echo -e "${WHITE}"
    cat << 'EOF'
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MonoLite ä¸‰è¯­è¨€ä¸€è‡´æ€§æµ‹è¯•æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚   â”‚ 1. æ•°æ®ç”Ÿæˆå™¨ â”‚  Go ç¨‹åºç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å’Œ MonoLite æ•°æ®æ–‡ä»¶               â”‚
â”‚   â”‚   (Go)       â”‚                                                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚          â”‚                                                              â”‚
â”‚          â–¼                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ testcases.   â”‚     â”‚ test.monodb  â”‚     â”‚ expected/    â”‚           â”‚
â”‚   â”‚ json         â”‚     â”‚ (æ•°æ®æ–‡ä»¶)    â”‚     â”‚ (é¢„æœŸç»“æœ)    â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                    â”‚                    â”‚                    â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                               â”‚                                         â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚          â–¼                    â–¼                    â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ 2. Go Runner â”‚     â”‚ 3. TS Runner â”‚     â”‚ 4.Swift Runnerâ”‚           â”‚
â”‚   â”‚  â”œâ”€ API æ¨¡å¼ â”‚     â”‚  â”œâ”€ API æ¨¡å¼ â”‚     â”‚  â”œâ”€ API æ¨¡å¼ â”‚           â”‚
â”‚   â”‚  â””â”€ Wireæ¨¡å¼ â”‚     â”‚  â””â”€ Wireæ¨¡å¼ â”‚     â”‚  â””â”€ Wireæ¨¡å¼ â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                    â”‚                    â”‚                    â”‚
â”‚          â–¼                    â–¼                    â–¼                    â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚ go_api.json  â”‚     â”‚ ts_api.json  â”‚     â”‚swift_api.jsonâ”‚           â”‚
â”‚   â”‚ go_wire.json â”‚     â”‚ ts_wire.json â”‚     â”‚swift_wire.jsonâ”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚          â”‚                    â”‚                    â”‚                    â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                               â”‚                                         â”‚
â”‚                               â–¼                                         â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                      â”‚ 5. éªŒè¯å™¨     â”‚  æ¯”è¾ƒæ‰€æœ‰ç»“æœï¼Œç”ŸæˆæŠ¥å‘Š              â”‚
â”‚                      â”‚   (Go)       â”‚                                   â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                             â”‚                                           â”‚
â”‚                             â–¼                                           â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                      â”‚ ä¸€è‡´æ€§æŠ¥å‘Š    â”‚                                   â”‚
â”‚                      â”‚ â”œâ”€ JSON      â”‚                                   â”‚
â”‚                      â”‚ â””â”€ Markdown  â”‚                                   â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
    echo -e "${NC}"
}

# æ‰“å°æµ‹è¯•ç±»åˆ«
print_test_categories() {
    echo -e "${WHITE}"
    cat << 'EOF'
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æµ‹è¯•ç”¨ä¾‹åˆ†ç±»                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ğŸ“ CRUD æ“ä½œ (30ä¸ª)                    ğŸ“ æŸ¥è¯¢æ“ä½œç¬¦ (25ä¸ª)              â”‚
â”‚     â”œâ”€ insertOne/insertMany               â”œâ”€ $eq, $ne, $gt, $gte        â”‚
â”‚     â”œâ”€ find/findOne                       â”œâ”€ $lt, $lte, $in, $nin       â”‚
â”‚     â”œâ”€ updateOne/updateMany               â”œâ”€ $exists, $type             â”‚
â”‚     â”œâ”€ deleteOne/deleteMany               â”œâ”€ $regex, $mod               â”‚
â”‚     â”œâ”€ replaceOne                         â”œâ”€ $and, $or, $nor, $not      â”‚
â”‚     â””â”€ findAndModify, distinct            â””â”€ $size, $all, $elemMatch    â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“ æ›´æ–°æ“ä½œç¬¦ (20ä¸ª)                    ğŸ“ èšåˆç®¡é“ (40ä¸ª)               â”‚
â”‚     â”œâ”€ $set, $unset, $rename              â”œâ”€ $match, $project, $sort    â”‚
â”‚     â”œâ”€ $inc, $mul, $min, $max             â”œâ”€ $limit, $skip, $count      â”‚
â”‚     â”œâ”€ $push, $pop, $pull                 â”œâ”€ $group (ç´¯åŠ å™¨)             â”‚
â”‚     â”œâ”€ $addToSet, $pullAll                â”œâ”€ $unwind, $lookup           â”‚
â”‚     â””â”€ $currentDate, $setOnInsert         â””â”€ $addFields, $replaceRoot   â”‚
â”‚                                                                         â”‚
â”‚  ğŸ“ ç´¢å¼•æ“ä½œ (15ä¸ª)                      ğŸ“ äº‹åŠ¡æ“ä½œ (20ä¸ª)               â”‚
â”‚     â”œâ”€ createIndex (å•/å¤åˆ/å”¯ä¸€)         â”œâ”€ startTransaction           â”‚
â”‚     â”œâ”€ listIndexes                        â”œâ”€ commitTransaction          â”‚
â”‚     â”œâ”€ dropIndex                          â”œâ”€ abortTransaction           â”‚
â”‚     â””â”€ å”¯ä¸€çº¦æŸéªŒè¯                       â””â”€ å›æ»šéªŒè¯                     â”‚
â”‚                                                                         â”‚
â”‚                        æ€»è®¡: ~150 ä¸ªæµ‹è¯•ç”¨ä¾‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
    echo -e "${NC}"
}

# æ‰“å°éªŒè¯çŸ©é˜µ
print_verification_matrix() {
    echo -e "${WHITE}"
    cat << 'EOF'
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           éªŒè¯æ¯”è¾ƒçŸ©é˜µ                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚              â”‚  Go API  â”‚ Go Wire â”‚ TS API â”‚ TS Wire â”‚Swift APIâ”‚Swift Wireâ”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Expected    â”‚    âœ“     â”‚    âœ“    â”‚   âœ“    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”‚              â”‚          â”‚         â”‚        â”‚         â”‚         â”‚         â”‚
â”‚  Go API      â”‚    -     â”‚    âœ“    â”‚   âœ“    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”‚  Go Wire     â”‚          â”‚    -    â”‚   âœ“    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”‚  TS API      â”‚          â”‚         â”‚   -    â”‚    âœ“    â”‚    âœ“    â”‚    âœ“    â”‚
â”‚  TS Wire     â”‚          â”‚         â”‚        â”‚    -    â”‚    âœ“    â”‚    âœ“    â”‚
â”‚  Swift API   â”‚          â”‚         â”‚        â”‚         â”‚    -    â”‚    âœ“    â”‚
â”‚                                                                         â”‚
â”‚  éªŒè¯å†…å®¹:                                                               â”‚
â”‚  â€¢ è¿”å›æ–‡æ¡£æ•°é‡æ˜¯å¦ä¸€è‡´                                                  â”‚
â”‚  â€¢ è¿”å›æ–‡æ¡£å†…å®¹æ˜¯å¦ä¸€è‡´ (æŒ‰ _id æ’åºåæ¯”è¾ƒ)                              â”‚
â”‚  â€¢ ä¿®æ”¹/åˆ é™¤è®¡æ•°æ˜¯å¦ä¸€è‡´                                                 â”‚
â”‚  â€¢ é”™è¯¯è¡Œä¸ºæ˜¯å¦ä¸€è‡´                                                      â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
    echo -e "${NC}"
}

# ä¸»ç¨‹åº
main() {
    clear
    print_header "MonoLite ä¸‰è¯­è¨€ä¸€è‡´æ€§æµ‹è¯• - å¯è§†åŒ–æ¼”ç¤º"

    echo -e "${PURPLE}é¡¹ç›®ç›®å½•:${NC} $PROJECT_DIR"
    echo -e "${PURPLE}æ—¶é—´:${NC} $(date)"
    echo ""

    # æ˜¾ç¤ºæµç¨‹å›¾
    print_flow_diagram

    read -p "æŒ‰ Enter æŸ¥çœ‹æµ‹è¯•ç±»åˆ«..."
    print_test_categories

    read -p "æŒ‰ Enter æŸ¥çœ‹éªŒè¯çŸ©é˜µ..."
    print_verification_matrix

    read -p "æŒ‰ Enter å¼€å§‹è¿è¡Œæµ‹è¯• (æˆ– Ctrl+C é€€å‡º)..."

    # Step 1: ç”Ÿæˆæµ‹è¯•æ•°æ®
    print_header "Step 1: ç”Ÿæˆæµ‹è¯•æ•°æ®"
    print_step "1" "è¿è¡Œæ•°æ®ç”Ÿæˆå™¨ (Go)"
    print_substep "è¿æ¥ MongoDB (localhost:27017)"
    print_substep "åˆ›å»º MonoLite æ•°æ®æ–‡ä»¶"
    print_substep "ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å®šä¹‰"

    cd "$PROJECT_DIR/testdata/generator"
    if go run . 2>&1 | head -20; then
        print_success "æµ‹è¯•æ•°æ®ç”Ÿæˆå®Œæˆ"
    else
        print_fail "æµ‹è¯•æ•°æ®ç”Ÿæˆå¤±è´¥"
        exit 1
    fi

    # Step 2: Go æµ‹è¯•
    print_header "Step 2: Go æµ‹è¯•è¿è¡Œå™¨"
    cd "$PROJECT_DIR/runner/go"

    print_step "2.1" "API æ¨¡å¼æµ‹è¯•"
    print_substep "ç›´æ¥è°ƒç”¨ engine.OpenDatabase API"
    if go run . --mode=api --output=../../reports/go_api.json 2>&1 | tail -5; then
        print_success "Go API æµ‹è¯•å®Œæˆ"
    else
        print_fail "Go API æµ‹è¯•å¤±è´¥"
    fi

    print_step "2.2" "Wire Protocol æ¨¡å¼æµ‹è¯•"
    print_substep "å¯åŠ¨ Wire Protocol æœåŠ¡å™¨"
    print_substep "ä½¿ç”¨ mongo-driver è¿æ¥æµ‹è¯•"
    if go run . --mode=wire --output=../../reports/go_wire.json 2>&1 | tail -5; then
        print_success "Go Wire æµ‹è¯•å®Œæˆ"
    else
        print_fail "Go Wire æµ‹è¯•å¤±è´¥"
    fi

    # Step 3: TypeScript æµ‹è¯•
    print_header "Step 3: TypeScript æµ‹è¯•è¿è¡Œå™¨"
    cd "$PROJECT_DIR/runner/ts"

    if [ ! -d "node_modules" ]; then
        print_substep "å®‰è£…ä¾èµ–..."
        npm install --silent
    fi

    print_step "3.1" "API æ¨¡å¼æµ‹è¯•"
    print_substep "ç›´æ¥è°ƒç”¨ Database.open API"
    if npx ts-node src/index.ts --mode=api --output=../../reports/ts_api.json 2>&1 | tail -5; then
        print_success "TypeScript API æµ‹è¯•å®Œæˆ"
    else
        print_fail "TypeScript API æµ‹è¯•å¤±è´¥"
    fi

    print_step "3.2" "Wire Protocol æ¨¡å¼æµ‹è¯•"
    print_substep "å¯åŠ¨ ProtocolServer"
    print_substep "ä½¿ç”¨ mongodb é©±åŠ¨è¿æ¥æµ‹è¯•"
    if npx ts-node src/index.ts --mode=wire --output=../../reports/ts_wire.json 2>&1 | tail -5; then
        print_success "TypeScript Wire æµ‹è¯•å®Œæˆ"
    else
        print_fail "TypeScript Wire æµ‹è¯•å¤±è´¥"
    fi

    # Step 4: Swift æµ‹è¯•
    print_header "Step 4: Swift æµ‹è¯•è¿è¡Œå™¨"
    cd "$PROJECT_DIR/runner/swift"

    if [ ! -x ".build/debug/Runner" ]; then
        print_substep "æ„å»º Swift è¿è¡Œå™¨..."
        swift build 2>/dev/null
    fi

    print_step "4.1" "API æ¨¡å¼æµ‹è¯•"
    print_substep "ç›´æ¥è°ƒç”¨ Database Actor API"
    if swift run Runner --mode=api --output=../../reports/swift_api.json 2>&1 | tail -5; then
        print_success "Swift API æµ‹è¯•å®Œæˆ"
    else
        print_fail "Swift API æµ‹è¯•å¤±è´¥ (å¯é€‰)"
    fi

    print_step "4.2" "Wire Protocol æ¨¡å¼æµ‹è¯•"
    print_substep "å¯åŠ¨ MongoWireTCPServer"
    print_substep "ä½¿ç”¨è‡ªå®šä¹‰ TCP å®¢æˆ·ç«¯è¿æ¥æµ‹è¯•"
    if swift run Runner --mode=wire --output=../../reports/swift_wire.json 2>&1 | tail -5; then
        print_success "Swift Wire æµ‹è¯•å®Œæˆ"
    else
        print_fail "Swift Wire æµ‹è¯•å¤±è´¥ (å¯é€‰)"
    fi

    # Step 5: éªŒè¯å’ŒæŠ¥å‘Š
    print_header "Step 5: ä¸€è‡´æ€§éªŒè¯"
    cd "$PROJECT_DIR/verifier"

    print_step "5" "ç”Ÿæˆä¸€è‡´æ€§æŠ¥å‘Š"
    print_substep "æ”¶é›†æ‰€æœ‰æµ‹è¯•ç»“æœ"
    print_substep "æ‰§è¡Œè·¨è¯­è¨€æ¯”è¾ƒ"
    print_substep "ç”Ÿæˆ JSON å’Œ Markdown æŠ¥å‘Š"

    if go run . 2>&1; then
        print_success "ä¸€è‡´æ€§æŠ¥å‘Šç”Ÿæˆå®Œæˆ"
    else
        print_fail "ä¸€è‡´æ€§æŠ¥å‘Šç”Ÿæˆå¤±è´¥"
    fi

    # æ˜¾ç¤ºæŠ¥å‘Šæ‘˜è¦
    print_header "æµ‹è¯•å®Œæˆ - æŠ¥å‘Šæ‘˜è¦"

    if [ -f "$PROJECT_DIR/reports/consistency_report.json" ]; then
        echo -e "${WHITE}ä¸€è‡´æ€§æŠ¥å‘Š:${NC}"
        echo ""
        cat "$PROJECT_DIR/reports/consistency_report.json" | head -30
        echo "..."
        echo ""
        echo -e "${GREEN}å®Œæ•´æŠ¥å‘Šä½ç½®:${NC}"
        echo "  JSON:     $PROJECT_DIR/reports/consistency_report.json"
        echo "  Markdown: $PROJECT_DIR/reports/consistency_report.md"
    fi

    # æ˜¾ç¤ºå„è¯­è¨€æµ‹è¯•ç»“æœæ–‡ä»¶
    echo ""
    echo -e "${WHITE}å„è¯­è¨€æµ‹è¯•ç»“æœ:${NC}"
    ls -la "$PROJECT_DIR/reports/"*.json 2>/dev/null || echo "  (æ— ç»“æœæ–‡ä»¶)"
}

# è¿è¡Œä¸»ç¨‹åº
main "$@"
